# Capter

* golang сервер (capter)
* торчащий shared key-value (capterka)

## Легенда

### Общая

При освоении планет и терраформинге появилась необходимость засылать определенные химические элементы, образцы почвы, примеры ландшафта на различные участки планеты, чтобы смотреть, что и где приживется. Для чистоты эксперимента, рассылающий модуль выбирает несколько мест случайным образом, отправляет туда образцы, и впоследствии проверяет, удачный ли был выбор.
Если образцы успешно прижились, эксперимент продолжается пока планета не будет признана полностью готовой к жизни, в противном случае, место на некоторое время исключается из списка пригодных. Чем больше экспериментов прижилось, тем более приоритетным будет место для жизни в будущем.

Такой системой оказался  C.A.P.T.E.R - Cosmic Automatic Pattern Transmitter-Exchanger-Receiver

### От первого лица

Облачко: ...Ещё один день на орбите...
ГГ: Грешная планета! Сколько нам еще тут болтаться в космосе?
    Есть новости от C.A.P.T.E.R?
Комп: Пришли результаты с мест 13 и 7, продолжаем эксперимент.
    Утеряна связь с местом 6.
ГГ: Опять этот шестой участок! А ведь так красиво выглядел!
    А 13 вообще посреди океана: вот как там жить будем?
Комп: Да, образцы почвы на 13 участке не приживаются, необходимо запросить дополнительные сведения.
ГГ: Запрашивай! И еще собери данные по всем участкам на урожайность картофеля - надоели уже эти тюбики!


## Описание файлов

### C.A.P.T.E.R

Сервис

+ Cosmic - утилиты
+ Automatic - основная логика C.A.P.T.E.R
+ Pattern - создание образцов
+ Transmitter - рассылка образцов
+ Excahger - приложение
+ Receiver - получение образцов


### C.A.P.T.E.R.Сa

БД

C.A.P.T.E.R.Сa - C.A.P.T.E.R Candidate

Место-кандидат для отправки образцов.

Задепоить только бинарник.

## Деплой

+ Capter: порт 1234
+ Capterca: порт 8081

### Build

    GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build

### Если Docker

После билда бинарников:

+ Capter: docker build -f Dockerfile-prod -t capter .
+ Capterca: docker build -t capterca .

Ну и дальше как обычно. (два контейнера в итоге) (можно еще volume сделать для баз)

### Если systemd

1. Поместить директорию capter куда-нибудь (с бинарником вместе (смотреть чтоб права не слетели))
2. Поместить бинарник capterca в /srv/ (с exec правами)
3. Создать два unit: capterca requires: network, capter requires: capterca

## Уязвимости

### LIST

>Простая уязвимость.
> Требует смекалки и знания REST (в частности http OPTIONS), либо реверса Go - так или иначе, поняв, как работает LIST можно таскать флаги пачками. Для защиты требуется запатчить бинарник или, что проще, спрятать Capterca за реверс-прокси и запретить все, кроме GET,POST,LEN (LEN нужно чекеру)

Capterca помимо GET и POST имеет также методы LEN, LIST и OPTIONS.
OPTIONS собственно рассказывает какие методы есть. 
LEN говорит количество записей в базе
LIST - принимает параметр $key, и выводит список всех ключей в базе, начинающихся с $key.

Таким образом, зная, что ключи в базе строятся по принципу timestamp-id, можно выбрать все ключи, начинающиеся с таймстемпа раунда, после чего пройтись по командам и сделать get для данных id.

Даже если бы LIST не было - всё равно есть возможность выводить все ключи для своей базы, после чего запрашивать у сервиса флаги по id.

Таким образом, чтобы закрыться от этой архитектурной уязвимости - стоит на сервисе сохранять в Capterca не с тем же id, а с неким внутренним, имея соответствие в локальной базе сервиса. Таким образом, даже зная все ключи из Capterca не будет возможности получить флаг - только зашифрованное значение.

### Crypto

>Криптография избыточна

Для шифрования используется пароль из 16 символов, но на деле из-за за сдвигов используется меньше. Более того, при внимательном рассмотрении оказывается, что вместо 16 символьного пароля, для расшифровки нужны лишь два uint32 числа.
Более того, эти числа можно легко вычислить, зная открытую часть. (см. sploits/capter/crypto/sploit.go)

Необходимо усилить криптографию, например увеличив количество раундов на блок, либо поменяв алгоритм, заменив XOR на что-то иное(хотя б на сложение)